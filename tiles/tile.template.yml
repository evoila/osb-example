---
name: osb-example # By convention lowercase with dashes
icon_file: icon/example.png
label: Example Open Service Broker
description: Example Service Broker

apply_open_security_group: true

requires_product_versions:
- name: osb-backend
  version : '~>0'

service_broker: true

properties:
- name: spring_profiles
  type: string
  label: SPRING_PROFILES
  default: pcf
- name: catalog_services_0_id
  type: uuid
  label: SERVICE_ID
- name: catalog_services_1_id
  type: uuid
  label: SERVICE_ID
- name: catalog_services_0_plans_0_id
  type: uuid
  label: PLAN_ID
- name: catalog_services_0_plans_1_id
  type: uuid
  label: PLAN_ID
- name: catalog_services_0_plans_2_id
  type: uuid
  label: PLAN_ID
- name: catalog_services_0_plans_3_id
  type: uuid
  label: PLAN_ID
- name: catalog_services_1_plans_0_id
  type: uuid
  label: PLAN_ID
- name: catalog_services_1_plans_1_id
  type: uuid
  label: PLAN_ID
- name: catalog_services_1_plans_2_id
  type: uuid
  label: PLAN_ID
- name: catalog_services_1_plans_3_id
  type: uuid
  label: PLAN_ID
- name: catalog_services_0_dashboardclient_id
  type: uuid
  label: SERVICE_DASHBOARD_CLIENT_ID
  default: osb-example
- name: catalog_services_1_dashboardclient_id
  type: uuid
  label: SERVICE_DASHBOARD_CLIENT_ID
  default: osb-example-second
- name: catalog_services_0_dashboardclient_secret
  type: secret
  label: SERVICE_DASHBOARD_CLIENT_SECRET
- name: catalog_services_1_dashboardclient_secret
  type: secret
  label: SERVICE_DASHBOARD_CLIENT_SECRET
- name: login_role
  type: string
  label: LOGIN_ROLE
  default: USER
- name: catalog_services_0_plans_0_platform
  type: string
  label: PLAN_PLATFORM
  default: EXISTING_SERVICE
- name: catalog_services_0_plans_1_platform
  type: string
  label: PLAN_PLATFORM
  default: EXISTING_SERVICE
- name: catalog_services_0_plans_2_platform
  type: string
  label: PLAN_PLATFORM
  default: EXISTING_SERVICE
- name: catalog_services_0_plans_3_platform
  type: string
  label: PLAN_PLATFORM
  default: EXISTING_SERVICE
- name: catalog_services_1_plans_0_platform
  type: string
  label: PLAN_PLATFORM
  default: EXISTING_SERVICE
- name: catalog_services_1_plans_1_platform
  type: string
  label: PLAN_PLATFORM
  default: EXISTING_SERVICE
- name: catalog_services_1_plans_2_platform
  type: string
  label: PLAN_PLATFORM
  default: EXISTING_SERVICE
- name: catalog_services_1_plans_3_platform
  type: string
  label: PLAN_PLATFORM
  default: EXISTING_SERVICE

property_blueprints:
  - name: service_instance_azs
    type: service_network_az_multi_select
    configurable: true
    optional: false

forms:
- name: osb_example
  label: Basic Configuration
  description: Configuration of the OSB Example Service Broker
  properties:
  - name: service_broker_name
    type: string
    label: Example Open Service Broker
    default: osb-example
  - name: catalog_bosh_azs
    label: Availability Zone
    type: service_network_az_multi_select

- name: osb_service
  label: Catalog Name
  description: Service Broker
  properties:
  - name: catalog_services_0_name
    type: string
    label: SERVICE_NAME
    default: osb-example
  - name: catalog_services_0_description
    type: string
    label: SERVICE_DESCRIPTION
    default: Example Open Service Broker
  - name: catalog_services_0_bindable
    type: boolean
    label: SERVICE_BINDABLE
    default: true


- name: osb_plan_1
  label: Catalog Plan 1
  description: Catalog Plan 1
  properties:
  - name: catalog_services_0_plans_0_name
    type: string
    label: PLAN_NAME
    default: xs
  - name: catalog_services_0_plans_0_description
    type: string
    label: PLAN_DESCRIPTION
    default: A small instance for low requirement apps
  - name: catalog_services_0_plans_0_free
    type: boolean
    label: PLAN_FREE
    default: true
  - name: catalog_services_0_plans_0_metadata_connections
    type: string
    label: SERVICE_CONNECTIONS
    default: 5

- name: osb_plan_2
  label: Catalog Plan 2
  description: Catalog Plan 2
  properties:
  - name: catalog_services_0_plans_1_name
    type: string
    label: PLAN_NAME
    default: s
  - name: catalog_services_0_plans_1_description
    type: string
    label: PLAN_DESCRIPTION
    default: A small instance for low requirement apps
  - name: catalog_services_0_plans_1_free
    type: boolean
    label: PLAN_FREE
    default: true
  - name: catalog_services_0_plans_1_metadata_connections
    type: string
    label: SERVICE_CONNECTIONS
    default: 5

- name: osb_plan_3
  label: Catalog Plan 3
  description: Catalog Plan 3
  properties:
  - name: catalog_services_0_plans_2_name
    type: string
    label: PLAN_NAME
    default: l
  - name: catalog_services_0_plans_2_description
    type: string
    label: PLAN_DESCRIPTION
    default: A small instance for low requirement apps
  - name: catalog_services_0_plans_2_free
    type: boolean
    label: PLAN_FREE
    default: true
  - name: catalog_services_0_plans_2_metadata_connections
    type: string
    label: SERVICE_CONNECTIONS
    default: 5

- name: osb_plan_4
  label: Catalog Plan 4
  description: Catalog Plan 4
  properties:
  - name: catalog_services_0_plans_3_name
    type: string
    label: PLAN_NAME
    default: xl
  - name: catalog_services_0_plans_3_description
    type: string
    label: PLAN_DESCRIPTION
    default: A small instance for low requirement apps
  - name: catalog_services_0_plans_3_free
    type: boolean
    label: PLAN_FREE
    default: true
  - name: catalog_services_0_plans_3_metadata_connections
    type: string
    label: SERVICE_CONNECTIONS
    default: 5



- name: osb_second_service
  label: Catalog Second Name
  description: Service Secound Broker
  properties:
  - name: catalog_services_1_name
    type: string
    label: SERVICE_NAME
    default: osb-example-second
  - name: catalog_services_1_description
    type: string
    label: SERVICE_DESCRIPTION
    default: Example Open Service Broker
  - name: catalog_services_1_bindable
    type: boolean
    label: SERVICE_BINDABLE
    default: true


- name: osb_second_plan_1
  label: Catalog Second Plan 1
  description: Catalog Second Plan 1
  properties:
  - name: catalog_services_1_plans_0_name
    type: string
    label: PLAN_NAME
    default: xs
  - name: catalog_services_1_plans_0_description
    type: string
    label: PLAN_DESCRIPTION
    default: A small instance for low requirement apps
  - name: catalog_services_1_plans_0_free
    type: boolean
    label: PLAN_FREE
    default: true
  - name: catalog_services_1_plans_0_metadata_connections
    type: string
    label: SERVICE_CONNECTIONS
    default: 5

- name: osb_second_plan_2
  label: Catalog Second Plan 2
  description: Catalog Second Plan 2
  properties:
  - name: catalog_services_1_plans_1_name
    type: string
    label: PLAN_NAME
    default: s
  - name: catalog_services_1_plans_1_description
    type: string
    label: PLAN_DESCRIPTION
    default: A small instance for low requirement apps
  - name: catalog_services_1_plans_1_free
    type: boolean
    label: PLAN_FREE
    default: true
  - name: catalog_services_1_plans_1_metadata_connections
    type: string
    label: SERVICE_CONNECTIONS
    default: 5

- name: osb_second_plan_3
  label: Catalog Second Plan 3
  description: Catalog Second Plan 3
  properties:
  - name: catalog_services_1_plans_2_name
    type: string
    label: PLAN_NAME
    default: l
  - name: catalog_services_1_plans_2_description
    type: string
    label: PLAN_DESCRIPTION
    default: A small instance for low requirement apps
  - name: catalog_services_1_plans_2_free
    type: boolean
    label: PLAN_FREE
    default: true
  - name: catalog_services_1_plans_2_metadata_connections
    type: string
    label: SERVICE_CONNECTIONS
    default: 5

- name: osb_second_plan_4
  label: Catalog Second Plan 4
  description: Catalog Second Plan 4
  properties:
  - name: catalog_services_1_plans_3_name
    type: string
    label: PLAN_NAME
    default: xl
  - name: catalog_services_1_plans_3_description
    type: string
    label: PLAN_DESCRIPTION
    default: A small instance for low requirement apps
  - name: catalog_services_1_plans_3_free
    type: boolean
    label: PLAN_FREE
    default: true
  - name: catalog_services_1_plans_3_metadata_connections
    type: string
    label: SERVICE_CONNECTIONS
    default: 5
packages:
- name: osb-bosh-monitoring
  type: bosh-release
  path: binaries/osb-bosh-monitoring-0.0.1.tgz
  
- name: osb_example
  type: app-broker
  needs_cf_credentials: true
  enable_global_access_to_plans: true
  consumes:
    rabbitmq:
      from: rabbitmq
      deployment: (( ..osb-backend.deployment_name ))
    haproxy-agent:
      from: haproxy-agent
      deployment: (( ..osb-backend.deployment_name ))
    mongodb:
      from: mongodb
      deployment: (( ..osb-backend.deployment_name ))
  manifest:
    path: binaries/osb-example.jar
    buildpack: java_buildpack_offline
    env:
      SPRING_PROFILES_ACTIVE: (( .properties.spring_profiles.value ))
      SPRING_SSL_ACCEPTSELFSIGNED: true
      SERVICE_KEY_MANAGER: osb-service-key-manager.(( $runtime.apps_domain ))
      SPRING_DATA_MONGODB_PORT: (( ..osb-backend.properties.mongodb_port.value ))
      SPRING_DATA_MONGODB_DATABASE: admin # (( .properties.spring_data_mongodb_database.value ))
      SPRING_DATA_MONGODB_USERNAME: admin #(( ..osb-backend.properties.mongodb_properties_mongodb_cred.identity ))
      SPRING_DATA_MONGODB_PASSWORD: pleasechangeme # ((  ..osb-backend.properties.mongodb_properties_mongodb_cred.password ))
      SPRING_RABBITMQ_PORT: (( ..osb-backend.properties.rabbitmq_port.value ))
      SPRING_RABBITMQ_VHOST: (( ..osb-backend.properties.rabbitmq_administrators_broker_vhost.value ))
      SPRING_RABBITMQ_USERNAME: (( ..osb-backend.properties.rabbitmq_administrators_broker_cred.identity  ))
      SPRING_RABBITMQ_PASSWORD: (( ..osb-backend.properties.rabbitmq_administrators_broker_cred.password ))
      HAPROXY_AGENT_ID: (( ..osb-backend.properties.haproxy_agent_id.value ))
      HAPROXY_AUTH_TOKEN: (( ..osb-backend.properties.haproxy_agent_token.value ))
      HAPROXY_TOKEN: (( ..osb-backend.properties.haproxy_agent_token.value ))
      BOSH_HOST: (( $director.hostname ))
      BOSH_USERNAME:  (( ..osb-backend.properties.service_broker_bosh_username.value ))
      BOSH_PASSWORD: (( ..osb-backend.properties.service_broker_bosh_password.value ))
      BOSH_STEMCELLVERSION: (( $self.stemcell_version ))
      GENERAL_ENDPOINTURL: https://(( .properties.service_broker_name.value )).(( $runtime.apps_domain ))
      ENDPOINTS_DEFAULT: https://(( .properties.service_broker_name.value )).(( $runtime.apps_domain ))
      CATALOG_SERVICES_0_DASHBOARD_URL:  https://(( .properties.service_broker_name.value )).(( $runtime.apps_domain ))/custom/v2/authentication
      CATALOG_SERVICES_0_DASHBOARD_AUTHENDPOINT: (( $runtime.uaa_url ))/oauth
      CATALOG_SERVICES_0_DASHBOARDCLIENT_REDIRECTURI: https://(( .properties.service_broker_name.value )).(( $runtime.apps_domain ))/custom/v2/authentication
      CATALOG_SERVICES_1_DASHBOARD_AUTHENDPOINT: (( $runtime.uaa_url ))/oauth
      CATALOG_SERVICES_1_DASHBOARDCLIENT_REDIRECTURI: https://(( .properties.service_broker_name.value )).(( $runtime.apps_domain ))/custom/v2/authentication
      CATALOG_SERVICES_0_PLANS_0_METADATA_NETWORKS_0_NAME: (( $self.service_network ))
      CATALOG_SERVICES_0_PLANS_1_METADATA_NETWORKS_0_NAME: (( $self.service_network ))
      CATALOG_SERVICES_0_PLANS_2_METADATA_NETWORKS_0_NAME: (( $self.service_network ))
      CATALOG_SERVICES_0_PLANS_3_METADATA_NETWORKS_0_NAME: (( $self.service_network ))

      CATALOG_SERVICES_1_PLANS_0_METADATA_NETWORKS_0_NAME: (( $self.service_network ))
      CATALOG_SERVICES_1_PLANS_1_METADATA_NETWORKS_0_NAME: (( $self.service_network ))
      CATALOG_SERVICES_1_PLANS_2_METADATA_NETWORKS_0_NAME: (( $self.service_network ))
      CATALOG_SERVICES_1_PLANS_3_METADATA_NETWORKS_0_NAME: (( $self.service_network ))
      
      CATALOG_SERVICES_0_PLANS_0_METADATA_BULLETS: 1 GB disk size,super-fast,awesome
      CATALOG_SERVICES_0_PLANS_1_METADATA_BULLETS: 10 GB disk size,super-fast,awesome
      CATALOG_SERVICES_0_PLANS_1_METADATA_COSTS_0_UNIT: MONTHLY
      CATALOG_SERVICES_0_PLANS_1_METADATA_COSTS_0_AMOUNT_EUR: 20
      CATALOG_SERVICES_0_PLANS_1_METADATA_COSTS_1_UNIT: MONTHLY
      CATALOG_SERVICES_0_PLANS_1_METADATA_COSTS_1_AMOUNT_EUR: 60

      CATALOG_SERVICES_0_PLANS_0_METADATA_AZS_0: az00
      CATALOG_SERVICES_0_PLANS_1_METADATA_AZS_0: az00
      CATALOG_SERVICES_0_PLANS_2_METADATA_AZS_0: az00
      CATALOG_SERVICES_0_PLANS_3_METADATA_AZS_0: az00
      
      CATALOG_SERVICES_1_PLANS_0_METADATA_AZS_0: az00
      CATALOG_SERVICES_1_PLANS_1_METADATA_AZS_0: az00
      CATALOG_SERVICES_1_PLANS_2_METADATA_AZS_0: az00
      CATALOG_SERVICES_1_PLANS_3_METADATA_AZS_0: az00
      
      CATALOG_SERVICES_0_METADATA_DISPLAYNAME: Example Open Service Broker
      CATALOG_SERVICES_0_METADATA_IMAGEURL: http://logo-load.com/uploads/posts/2016-08/example-logo.png
      CATALOG_SERVICES_0_METADATA_LONGDESCRIPTION: Managed, highly available, Example clusters in the cloud
      CATALOG_SERVICES_0_METADATA_PROVIDERDISPLAYNAME: evoila
      CATALOG_SERVICES_0_METADATA_DOCUMENTATIONURL: http://docs.evoila.de
      CATALOG_SERVICES_0_METADATA_SUPPORTURL: http://support.evoila.de
      CATALOG_SERVICES_0_TAGS: Best Performance Postgresql, High Availability, PgPool included

      CATALOG_SERVICES_1_METADATA_DISPLAYNAME: Example Open Service Broker
      CATALOG_SERVICES_1_METADATA_IMAGEURL: http://logo-load.com/uploads/posts/2016-08/example-logo.png
      CATALOG_SERVICES_1_METADATA_LONGDESCRIPTION: Managed, highly available, Example clusters in the cloud
      CATALOG_SERVICES_1_METADATA_PROVIDERDISPLAYNAME: evoila
      CATALOG_SERVICES_1_METADATA_DOCUMENTATIONURL: http://docs.evoila.de
      CATALOG_SERVICES_1_METADATA_SUPPORTURL: http://support.evoila.de
      CATALOG_SERVICES_1_TAGS: Best Performance Postgresql, High Availability, PgPool included
